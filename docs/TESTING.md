# Testing Guide

This document describes the strict workflow and standards for testing the VisualCare File Migration Renamer project.

## Test Workflow and Rules

### 1. Test Matrix CSVs
- All test cases are defined in CSV files in `tests/fixtures/` (e.g., `name_extraction_cases.csv`, `category_test_cases.csv`).
- Each matrix must have clear column headers and cover all relevant scenarios.

### 2. Scaffolding BATS Tests
- **BATS/unit tests are always generated from CSV matrices** using scaffolding scripts.
- Example commands:
  ```bash
  python3 tests/scripts/generate_bats_tests.py name
  python3 tests/scripts/generate_bats_tests.py date
  python3 tests/scripts/generate_bats_tests.py combined
  ```
- Never write BATS/unit tests by hand for extraction logic; always generate them from the matrix.

### 3. Scaffolding Test Files
- **File manipulation/integration tests scaffold input files and directories from the CSV matrix** using setup scripts.
- Example commands:
  ```bash
  python3 tests/scripts/setup_category_test_files.py
  python3 tests/scripts/setup_multi_level_test_files.py
  ```
- Input files are created in `tests/test-files/from-<testname>/` and output files will be created in `tests/test-files/to-<testname>/`.

### 4. Running the Main Logic
- The main CLI script is run in test mode to process files:
  ```bash
  python3 main.py --test-mode --test-name <testname>
  ```
- This applies the real extraction and renaming logic to all files in the input directory.

### 5. Output Validation
- After processing, a validation script checks that all output filenames in `to-<testname>/` match the expected filenames from the CSV matrix.
- Any missing, extra, or mismatched files cause the test to fail and report the issue.
- Example validation command:
  ```bash
  python3 tests/scripts/validate_test_outputs.py <testname>
  ```

### 6. Reporting and Output Preservation
- Test outputs are preserved in the `to-<testname>/` directories for manual inspection.
- All test failures provide clear, actionable error messages.

### 7. Test Independence and Cleanup
- Each test is independent and repeatable.
- Tests clean up their input and output directories before each run.
- No test depends on the state of another.

### 8. Code and File Organization
- All test-related files, scripts, and configs must be located within the `tests/` directory structure.
- Test fixtures (CSVs) in `tests/fixtures/`, setup and scaffolding scripts in `tests/scripts/`, generated BATS tests in `tests/unit/`, and test files in `tests/test-files/`.

### 9. Output Validation BATS Tests
- For each test matrix (basic, category, multi-level), a BATS test file is scaffolded to assert that every expected output file exists in the correct directory.
- These BATS tests are generated by running:
  ```bash
  python3 tests/scripts/generate_output_validation_bats.py
  ```
- The generated files are:
  - tests/unit/output_validation_basic.bats
  - tests/unit/output_validation_category.bats
  - tests/unit/output_validation_multi_level.bats
- These tests are run as part of the full suite and will fail if any expected output file is missing or misnamed.

### 10. Regenerating Output Validation Tests
- Whenever you update a test matrix, rerun the scaffolding script:
  ```bash
  python3 tests/scripts/generate_output_validation_bats.py
  ```
- This ensures the BATS validation tests always match the current matrix.

## Summary Table

| Step                | What Happens                                                                 |
|---------------------|------------------------------------------------------------------------------|
| 1. Scaffold BATS    | Scripts generate BATS/unit tests from CSV matrices                            |
| 2. Scaffold Files   | Setup scripts create input files/dirs from CSV matrix                         |
| 3. Run main.py      | Real extraction/renaming logic processes files, creates output in `to-*`      |
| 4. Validate         | Validation script checks output filenames against CSV matrix                   |
| 5. Report           | Any mismatch is reported; outputs are preserved for inspection                |
| 6. Clean/Repeat     | Next test run cleans and repeats the process                                  |

## Extension and Contribution Rules
- When adding new features, always:
  1. Create or update a CSV matrix in `tests/fixtures/`.
  2. Update or create scaffolding scripts to generate BATS/unit tests and input files.
  3. Ensure validation and reporting are in place for new test cases.
  4. Follow the directory and code organization rules above.

## Documentation Requirements
- All test matrices must have clear column headers and descriptions.
- Setup and scaffolding scripts must provide usage instructions.
- Test runners must show clear progress and results.
- All test failures must provide actionable error messages.